name: Tests
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - release/pyats-integration-v1.1-beta

jobs:
  # PERFORMANCE INVESTIGATION: Isolated tests (no parallelism)
  perf-isolated:
    name: "Perf Isolated (${{ matrix.python }}) #${{ matrix.run }}"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python: ["3.10", "3.11", "3.12", "3.13"]
        run: [1, 2, 3]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python ${{ matrix.python }}
        run: uv python install ${{ matrix.python }}

      - name: System Info
        run: |
          echo "=== System Info ==="
          uname -a
          cat /proc/cpuinfo | grep "model name" | head -1
          cat /proc/cpuinfo | grep "processor" | wc -l
          free -h
          echo "==================="

      - name: Install dependencies
        run: uv sync --extra dev --extra adapters

      - name: "Performance test (ISOLATED, no parallelism)"
        run: |
          uv run pytest tests/integration/test_discovery_integration.py::TestDiscoveryPerformance::test_categorization_performance -v -s

  # PERFORMANCE INVESTIGATION: With parallelism 
  perf-parallel:
    name: "Perf Parallel (${{ matrix.python }})"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        python: ["3.10", "3.13"]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python ${{ matrix.python }}
        run: uv python install ${{ matrix.python }}

      - name: System Info
        run: |
          echo "=== System Info ==="
          uname -a
          cat /proc/cpuinfo | grep "model name" | head -1
          nproc
          free -h
          echo "==================="

      - name: Install dependencies
        run: uv sync --extra dev --extra adapters

      - name: "All tests with parallelism (-n auto)"
        run: |
          uv run pytest tests/ -n auto --dist loadscope -v 2>&1 | tee output.txt || true
          echo ""
          echo "=== PERFORMANCE TEST OUTPUT ==="
          grep -A 30 "PERFORMANCE TEST DIAGNOSTICS" output.txt || echo "Not found in output"

  # PERFORMANCE INVESTIGATION: Variance test (10 iterations on 3.13)
  perf-variance:
    name: "Perf Variance 3.13 (10 runs)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python 3.13
        run: uv python install 3.13

      - name: System Info
        run: |
          echo "=== System Info ==="
          uname -a
          cat /proc/cpuinfo | grep "model name" | head -1
          nproc
          free -h
          echo "==================="

      - name: Install dependencies
        run: uv sync --extra dev --extra adapters

      - name: "10 iterations of performance test"
        run: |
          echo "Running 10 iterations to measure variance..."
          for i in {1..10}; do
            echo ""
            echo "========== Iteration $i =========="
            uv run pytest tests/integration/test_discovery_integration.py::TestDiscoveryPerformance::test_categorization_performance -v -s 2>&1 || true
          done
